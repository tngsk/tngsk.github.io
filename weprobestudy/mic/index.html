<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UserMedia - Mic</title>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.js"></script>
</head>

<body>

    <canvas id="canvas"></canvas>
    <button id="start">start</button>
    <button id="stop">stop</button>
    <button id="capture">capture</button>
    <div id="captureValue"></div>
    <div id="debug"></div>

    <script>

        let r = 0
        let x = 0
        let captureValue = 0;

        function setup() {
            createCanvas(300, 300)
            frameRate(15)
        }

        function draw() {

            // background(0)

            r = map(meter.getValue(), -99, 0, 150, 0, true)
            if (r > 100) {
                fill(255, 0, 0)
            } else {
                fill(255)
            }
            // ellipse(width/2, height/2, r, r)
            point(x % width, r)
            if (x % width == 0) {
                x = 0
                background(255)
            }
            x += 1
        }

        const debug = (text) => {
            console.log(text)
            document.getElementById('debug').innerText = text
        }

        const meter = new Tone.Meter({
            smoothing: 0.8,
            mute:true
        })

        const mic = new Tone.UserMedia({
            volume: -12,
            mute: false
        }).connect(meter)

        let timerID = 0

        document.getElementById('stop').addEventListener('click', () => {
            clearInterval(timerID);
            mic.close();
        })

        document.getElementById('start').addEventListener('click', () => {
            Tone.start()
            // Tone.Destination.mute = true;
            mic.open().then(() => {
                timerID = setInterval(() => {
                    // debug(meter.getValue())
                    debug(`mic:${mic.state}`)
                }, 100);
                debug(mic.deviceId);
            }).catch(error => {
                debug('timer error');
            })
        })

        document.getElementById('capture').addEventListener('click', () => {
            document.getElementById('captureValue').innerText = meter.getValue()
        })

    </script>
</body>

</html>
