<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UserMedia - Mic</title>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.js"></script>
</head>

<body>

    <canvas id="canvas"></canvas>
    <button id="start">start</button>
    <button id="stop">stop</button>
    <button id="capture">capture</button>
    <div id="captureValue"></div>
    <div id="debug"></div>

    <script>

        let r = 0
        let x = 0
        let captureValue = 0;

        function setup() {
            createCanvas(300, 300)
            frameRate(60)
            noStroke()
        }

        function draw() {

            background(255)

            r = map(captureValue, -99, 0, 0, 100, true)
            if (r > 80) {
                fill(255,0,0)
            } else {
                fill(100,100,100)
            }
            ellipse(width/2, height/2, r, r)
            // point(x % width, r)
            // if (x % width == 0) {
            //     x = 0
            //     background(255)
            // }
            // x += 1
        }

        const debug = (text) => {
            console.log(text)
            document.getElementById('debug').innerText = text
        }

        let timerID = 0

        document.getElementById('stop').addEventListener('click', () => {
            clearInterval(timerID);
            mic.close();
        })

        document.getElementById('start').addEventListener('click', async () => {

            Tone.start()

            const meter = new Tone.Meter({
                smoothing: 0.2,
                mute: true
            })

            const mic = new Tone.UserMedia({
                volume: 0,
                mute: false
            }).connect(meter)

            // Tone.Destination.mute = true;
            await mic.open().then(() => {
                timerID = setInterval(() => {
                    captureValue = meter.getValue()
                    debug(`mic:${mic.state}`)
                }, 16.6);
                debug(mic.deviceId);
            }).catch(error => {
                debug('mic open error');
            })
        })

        document.getElementById('capture').addEventListener('click', () => {
            document.getElementById('captureValue').innerText = captureValue
        })

    </script>
</body>

</html>
